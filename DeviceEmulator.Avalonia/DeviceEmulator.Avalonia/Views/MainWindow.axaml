<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:AvaloniaEdit="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
        xmlns:vm="clr-namespace:DeviceEmulator.ViewModels"
        x:Class="DeviceEmulator.Views.MainWindow"
        Title="Device Emulator - VS Code Style" Width="1400" Height="900"
        Background="{StaticResource BgDark}">
    
    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*,22"> <!-- Main Content, Status Bar -->
        
        <!-- Main Layout -->
        <Grid ColumnDefinitions="48,260,1,*,1,320">
            
            <!-- 0: Activity Bar -->
            <Border Grid.Column="0" Background="{StaticResource BgActivityBar}">
                <StackPanel Spacing="24" Margin="0,16">
                    <!-- Files -->
                    <PathIcon Data="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z" 
                              Foreground="White" Width="24" Height="24" ToolTip.Tip="Explorer" HorizontalAlignment="Center"/>
                    <!-- Search -->
                    <PathIcon Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" 
                              Foreground="#666666" Width="24" Height="24" ToolTip.Tip="Search" HorizontalAlignment="Center"/>
                    <!-- Git -->
                    <PathIcon Data="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" 
                              Foreground="#666666" Width="24" Height="24" ToolTip.Tip="Source Control" HorizontalAlignment="Center"/>
                    <!-- Debug -->
                    <PathIcon Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" 
                              Foreground="#666666" Width="24" Height="24" ToolTip.Tip="Run and Debug" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- 1: Sidebar (Explorer) -->
            <Border Grid.Column="1" Background="{StaticResource BgSidebar}">
                <Grid RowDefinitions="35,*,Auto">
                    <!-- Sidebar Header -->
                    <Border Padding="20,0">
                        <TextBlock Text="EXPLORER" VerticalAlignment="Center" FontSize="11" FontWeight="Bold" Foreground="#BBBBBB"/>
                    </Border>
                    
                    <!-- TreeView -->
                    <ScrollViewer Grid.Row="1" Padding="0,5">
                        <TreeView ItemsSource="{Binding Categories}" Background="Transparent" BorderThickness="0">
                            <TreeView.Styles>
                                <Style Selector="TreeViewItem">
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                </Style>
                            </TreeView.Styles>
                            <TreeView.DataTemplates>
                                <TreeDataTemplate DataType="{x:Type vm:DeviceCategoryViewModel}" ItemsSource="{Binding Devices}">
                                    <StackPanel Orientation="Horizontal" Spacing="6" Background="Transparent" Height="24">
                                        <TextBlock Text="ðŸ“" VerticalAlignment="Center" FontSize="14"/>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center" FontWeight="Bold" Foreground="{StaticResource TextPrimary}"/>
                                        <Border Background="#333333" CornerRadius="4" Padding="6,1" VerticalAlignment="Center" Margin="4,0,0,0">
                                            <TextBlock Text="{Binding Devices.Count}" Foreground="{StaticResource TextSecondary}" FontSize="11"/>
                                        </Border>
                                    </StackPanel>
                                </TreeDataTemplate>
                                <DataTemplate DataType="{x:Type vm:DeviceTreeItemViewModel}">
                                    <Border Background="Transparent" Padding="4,2" Tapped="OnDeviceItemClick" Cursor="Hand" ToolTip.Tip="{Binding DisplayName}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <Ellipse Width="8" Height="8" Fill="{Binding StatusColorBrush}" VerticalAlignment="Center"/>
                                            <TextBlock Text="ðŸ“„" FontSize="14" VerticalAlignment="Center" Foreground="#AAAAAA"/>
                                            <TextBlock Text="{Binding Config.Name}" VerticalAlignment="Center" Foreground="{StaticResource TextPrimary}"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </TreeView.DataTemplates>
                        </TreeView>
                    </ScrollViewer>

                    <!-- Add Buttons (Bottom of Sidebar) -->
                    <StackPanel Grid.Row="2" Margin="10" Spacing="8">
                        <Button Content="Add Serial Device" Classes="primary" HorizontalAlignment="Stretch" Click="OnAddSerialDevice" FontSize="12"/>
                        <Button Content="Add TCP Device" Classes="primary" HorizontalAlignment="Stretch" Click="OnAddTcpDevice" FontSize="12"/>
                        <Button Content="Remove Device" Classes="danger" HorizontalAlignment="Stretch" Click="OnRemoveDevice" IsEnabled="{Binding HasSelectedDevice}" FontSize="12"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 2: Splitter -->
            <GridSplitter Grid.Column="2" Background="{StaticResource BorderBrush}" ResizeDirection="Columns"/>

            <!-- 3: Editor Area -->
            <Grid Grid.Column="3" RowDefinitions="35,*,1,200">
                
                <!-- Editor Tabs & Toolbar -->
                <Border Background="{StaticResource BgHeader}">
                    <Grid ColumnDefinitions="*,Auto">
                        <!-- Pseudo Tab -->
                        <StackPanel Orientation="Horizontal">
                            <Border Background="{StaticResource EditorBg}" Padding="12,6" BorderBrush="{StaticResource AccentBrush}" BorderThickness="0,2,0,0">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="C#" FontSize="12" Foreground="{StaticResource AccentBrush}" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding SelectedDevice.Config.Name, FallbackValue='No Selection'}" FontSize="12" Foreground="White" VerticalAlignment="Center"/>
                                    <TextBlock Text="âœ•" Margin="8,0,0,0" FontSize="10" Foreground="#CCCCCC" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Toolbar Buttons (Right aligned in tab bar) -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="4" IsVisible="{Binding HasSelectedDevice}">
                             <Button Content="â–¶ï¸ Run" Click="OnToggleRunning" IsVisible="{Binding !SelectedDevice.IsRunning}" Classes="success" Padding="8,4" FontSize="12" ToolTip.Tip="Run Device"/>
                             <Button Content="â¹ï¸ Stop" Click="OnToggleRunning" IsVisible="{Binding SelectedDevice.IsRunning}" Classes="danger" Padding="8,4" FontSize="12" ToolTip.Tip="Stop Device"/>
                             <Button Content="âš™ï¸ Compile" Click="OnCompileScript" Classes="primary" Padding="8,4" FontSize="12" ToolTip.Tip="Compile Script"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Editor + Debug Toolbar Overlay -->
                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                         <RowDefinition Height="Auto"/> <!-- Debug Bar -->
                         <RowDefinition Height="*"/> <!-- Editor -->
                    </Grid.RowDefinitions>
                    
                    <!-- Debug Toolbar (Floating style or top bar) -->
                    <Border Background="#2D2D30" Padding="8" IsVisible="{Binding SelectedDevice.IsDebuggingEnabled}">
                         <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="â–¶ï¸ Continue" Click="OnDebugContinue" IsEnabled="{Binding IsPaused}" Background="#388E3C" Padding="12,4"/>
                                <Button Content="â­ï¸ Step" Click="OnDebugStep" IsEnabled="{Binding IsPaused}" Background="#007ACC" Padding="12,4"/>
                                <Button Content="â¹ï¸ Stop Debug" Click="OnDebugStop" IsEnabled="{Binding IsDebugging}" Background="#D32F2F" Padding="12,4"/>
                            </StackPanel>
                            <Border Grid.Column="2" Background="{StaticResource AccentBrush}" CornerRadius="4" Padding="8,2" IsVisible="{Binding IsPaused}">
                                <TextBlock Text="PAUSED" FontWeight="Bold" Foreground="White" FontSize="11"/>
                            </Border>
                         </Grid>
                    </Border>
                    
                    <!-- TextEditor -->
                    <AvaloniaEdit:TextEditor Grid.Row="1" x:Name="ScriptEditor"
                                             FontFamily="Consolas, Menlo, monospace"
                                             FontSize="14"
                                             Foreground="#D4D4D4"
                                             ShowLineNumbers="True"
                                             HorizontalScrollBarVisibility="Auto"
                                             VerticalScrollBarVisibility="Visible"/>
                </Grid>

                <!-- Splitter -->
                <GridSplitter Grid.Row="2" Background="{StaticResource BorderBrush}" ResizeDirection="Rows"/>

                <!-- Bottom Panel (Output) -->
                <Border Grid.Row="3" Background="{StaticResource BgSidebar}">
                    <Grid RowDefinitions="28,*">
                        <StackPanel Orientation="Horizontal" Margin="10,0">
                            <TextBlock Text="OUTPUT" VerticalAlignment="Center" FontSize="11" Foreground="#BBBBBB" Margin="0,0,16,0"/>
                            <TextBlock Text="DEBUG CONSOLE" VerticalAlignment="Center" FontSize="11" Foreground="#666666" Margin="0,0,16,0"/>
                            <TextBlock Text="PROBLEMS" VerticalAlignment="Center" FontSize="11" Foreground="#666666"/>
                            
                            <!-- Clear Button -->
                            <Button Content="Clear" Click="OnClearLog" Padding="6,2" FontSize="10" Margin="20,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <TextBox Grid.Row="1" Text="{Binding SelectedDeviceLog, Mode=OneWay}"
                                 IsReadOnly="True" TextWrapping="Wrap"
                                 Background="{StaticResource BgDark}" BorderThickness="0"
                                 FontFamily="Consolas, Menlo, monospace" Foreground="#DDDDDD"
                                 FontSize="12" Padding="8"/>
                    </Grid>
                </Border>
                
                <!-- Error Message Overlay -->
                 <Border Grid.Row="1" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="20" Background="#333333" BorderBrush="#D32F2F" BorderThickness="1" CornerRadius="4" Padding="10" IsVisible="{Binding HasError}">
                    <StackPanel>
                        <TextBlock Text="âš ï¸ Error" Foreground="#FF6B6B" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBlock Text="{Binding ErrorMessage}" Foreground="#CCCCCC" TextWrapping="Wrap" MaxWidth="300"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- 4: Splitter -->
            <GridSplitter Grid.Column="4" Background="{StaticResource BorderBrush}" ResizeDirection="Columns"/>

            <!-- 5: Right Panel (Properties) -->
            <Border Grid.Column="5" Background="{StaticResource BgSidebar}">
                <Grid RowDefinitions="35,Auto,*,4,200">
                    <Border Padding="10,0" Background="{StaticResource BgSidebar}">
                        <TextBlock Text="PROPERTIES" VerticalAlignment="Center" FontSize="11" FontWeight="Bold" Foreground="#BBBBBB"/>
                    </Border>
                    
                    <!-- Settings -->
                    <ScrollViewer Grid.Row="2" Padding="10" IsVisible="{Binding HasSelectedDevice}">
                        <StackPanel Spacing="12">
                             <!-- Common -->
                             <StackPanel>
                                <TextBlock Text="Name" FontSize="11" Foreground="{StaticResource TextSecondary}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding SelectedDevice.Config.Name, Mode=TwoWay}"/>
                             </StackPanel>
                             <CheckBox Content="Enable Debugging" IsChecked="{Binding SelectedDevice.IsDebuggingEnabled}" Margin="0,4"/>
                             <CheckBox Content="Hex Mode" IsChecked="{Binding SelectedDevice.Config.IsHexMode, Mode=TwoWay}" Margin="0,4"/>
                             
                             <Separator Background="{StaticResource BorderBrush}" Height="1" Margin="0,8"/>
                             
                             <!-- Serial -->
                             <StackPanel IsVisible="{Binding IsSerialDevice}" Spacing="10">
                                <TextBlock Text="SERIAL SETTINGS" FontWeight="Bold" FontSize="10" Foreground="{StaticResource TextSecondary}"/>
                                <StackPanel>
                                    <TextBlock Text="Port" FontSize="11" Foreground="{StaticResource TextSecondary}"/>
                                    <ComboBox ItemsSource="{Binding AvailablePorts}" SelectedItem="{Binding SelectedDevice.Config.PortName, Mode=TwoWay}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Baud Rate" FontSize="11" Foreground="{StaticResource TextSecondary}"/>
                                    <ComboBox ItemsSource="{Binding AvailableBaudRates}" SelectedItem="{Binding SelectedDevice.Config.BaudRate, Mode=TwoWay}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                             </StackPanel>

                             <!-- TCP -->
                             <StackPanel IsVisible="{Binding IsTcpDevice}" Spacing="10">
                                <TextBlock Text="TCP SETTINGS" FontWeight="Bold" FontSize="10" Foreground="{StaticResource TextSecondary}"/>
                                <StackPanel>
                                    <TextBlock Text="Port" FontSize="11" Foreground="{StaticResource TextSecondary}"/>
                                    <TextBox Text="{Binding SelectedDevice.Config.Port, Mode=TwoWay}"/>
                                </StackPanel>
                             </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                    
                    <GridSplitter Grid.Row="3" Background="{StaticResource BorderBrush}" ResizeDirection="Rows"/>

                    <!-- Variables -->
                    <Grid Grid.Row="4" RowDefinitions="Auto,*">
                        <Border Padding="10,6" Background="{StaticResource BgSidebar}">
                            <TextBlock Text="VARIABLES" FontSize="11" FontWeight="Bold" Foreground="#BBBBBB"/>
                        </Border>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding Variables}"
                                  AutoGenerateColumns="False" IsReadOnly="True"
                                  Background="{StaticResource BgDark}" Foreground="#CCCCCC"
                                  BorderThickness="0" GridLinesVisibility="None" HeadersVisibility="Column">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="80"/>
                                <DataGridTextColumn Header="Value" Binding="{Binding ValueString}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Status Bar -->
        <Border Grid.Row="1" Background="{StaticResource AccentBrush}">
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="10,0">
                <StackPanel Orientation="Horizontal" Spacing="12">
                     <PathIcon Data="M2,21L23,12L2,3V10L17,12L2,14V21Z" Width="12" Height="12" Foreground="White" VerticalAlignment="Center"/>
                     <TextBlock Text="{Binding SelectedDevice.Config.Name, FallbackValue='Ready'}" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="16">
                     <TextBlock Text="Ln 1, Col 1" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                     <TextBlock Text="UTF-8" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                     <TextBlock Text="C#" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
